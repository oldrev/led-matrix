# 应用层报文协议概述

* 报文总是由头部及报文内容组成
* 单个报文长度包含头部总不能超过 512 字节
* 两个数据帧之间发送的时间间隔不能低于 120 毫秒
* 同一报文分包发送的数据帧之间的时间间隔不能大于 500 毫秒，否则视为失败

!!! note "注意"
    后续硬件升级可能会提升上述报文长度限制，以具体硬件为准。

## 应用层消息报文头

每个报文总是以固定 8 个字节的消息报文头开始：

```c
struct PackageHeader {
    uint8_t     Magic;  // 1 字节的报文标识，固定为 `0x66`
    uint32_t    ID;     // 4 字节 32 位整型的报文 ID，用于标识报文
    uint8_t     Type;   // 1 字节消息类型，用于标识此报文的类型，由具体协议定义。
    uint16_t    Size;   // 2 字节，包含此头部的报文总长
};
```

报文头后面紧跟着报文内容，具体格式参加报文定义。

* 如果报文是双向通信需要接收方响应，接收方响应的报文与发送方的报文 ID 相同。
* 报文 ID 通常可以使用 Unix 时间填充。


# 应用层消息报文定义

## `0x01` - 系统复位

触发系统复位，重启主控单片机。

本功能基本无需客户端调用。

### 请求报文定义

* 消息类型： `0x01`
* 报文总长：`8+0` 字节（“8”表示报文头长度，“+0”表示报文内容长度为“0”，后面不再赘述）
* 报文应答：无

### 请求报文结构：

无

## `0x02` - 查询设备信息

查询设备信息，目前版本仅返回 MAC 地址

### 请求报文定义

* 消息类型： `0x02`
* 报文总长：`8+0` 字节
* 报文应答：有

### 请求报文结构：

无

### 应答报文定义

* 消息类型： `0x02`
* 报文总长度： `8+6` 字节

### 应答报文结构

```C
struct HelloResponse {
    uint8_t Mac[6]; // 6 个字节表示的蓝牙设备 MAC 地址
};
```



## `0x03` - 填充颜色设置

用于将整个显示矩阵填充为某个颜色索引，填充黑色就相当于关掉所有的 LED 灯珠。

### 请求报文定义

* 消息类型： `0x03`
* 报文总长：`8+1` 字节
* 报文应答：无

### 请求报文结构：

```c
struct SetPixel {
    uint8_t ColorIndex;    // 调色板颜色索引，范围 0~15
};
```

## `0x05` - 按照坐标设置单像素颜色

用于按照 X, Y 定义的列和行设置单个像素的颜色索引。

### 请求报文定义

* 消息类型： `0x05`
* 报文总长：`8+5` 字节
* 报文应答：无

### 请求报文结构：

```c
struct SetPixel {
    uint16_t X;            // 2字节16位列位置，从 0 开始
    uint16_t Y;            // 2字节16位行位置，从 0 开始
    uint8_t ColorIndex;    // 调色板颜色索引，范围 0~15
};
```

## `0xA1` - 显示设置

用于配置系统的显示参数。系统参数成功修改以后单片机将会自动重启进入待连接状态，需要重新进行连接操作，且灯珠将全部关闭。

本功能通常用于系统初始化配置，非日常业务功能。

### 请求报文定义

* 消息类型： `0xA1`
* 报文总长度： `8+58` 字节
* 报文应答：有

### 请求报文结构

```c
struct DisplaySettings {
    uint16_t LedCount;       // 总灯珠，两字节
    uint16_t XMax;           // 每行像素数，两字节
    uint16_t YMax;           // 总行数，两字节
    uint16_t XSkip;          // 行内跳过的，两字节
    uint16_t YSkip;          // 列之间跳过的，两字节
    uint8_t Palette[16 * 3]; // 调色盘，16 个索引，每个索引 RGB 三个通道一个字节一个通道共三字节
};
```

### 应答报文定义

* 消息类型： `0xA1`
* 报文总长度： `8+1` 字节

### 应答报文结构

```c
struct DisplaySettingsResponse {
    uint8_t Result;         // 0 表示成功，非 0 表示失败
};
```


## `0xFF` - 恢复出厂设置

用于将硬件内部的设置恢复为出厂默认设置并重启硬件。

### 请求报文定义

* 消息类型： `0xFF`
* 报文总长度： `8+0` 字节
* 报文应答：无

### 请求报文结构

无